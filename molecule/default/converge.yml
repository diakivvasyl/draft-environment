---
# This is exact copy of main playbook, except oefenweb.swapfile is skipped
# because it's not possible to test it on Travis CI. Also we manually add
# vagrant user as it does not exist in Docker.
- hosts: all
  become: true

  pre_tasks:
    - name: Add vagrant user
      user:
        name: vagrant
        # This password hash has been generated by running the following command
        # with password 'vagrant':
        #
        # mkpasswd --method=sha-512
        password: $6$4kot6S9fS2oGx$gUxPU4xvSSoMku2OHTwPtCDLNCU4OszJMv6616/1DmaLel15k5hNha451ce4tP6hIMd2H.suCv8cb/NNASdPd0
        uid: 1000

    # Some keys in the 'vagrant' dict are being populated by the Vagrant.
    # Molecule uses Docker under the hood. Let's fill the gap.
    - name: Add missing variables
      set_fact:
        vagrant: "{{ vagrant | combine(overrides, recursive=true) }}"
        draft_features:
          - mailhog
          - git_config
          - apache2
          - mysql
          - php
          - composer
          - java
          - solr
      vars:
        overrides:
          hostname: molecule
          ip_address: 10.10.10.10

  roles:
    - ../../provisioning/roles/draft
    - ../../provisioning/roles/git_config
    - ../../provisioning/roles/apache2
    - { role: geerlingguy.mysql, mysql_python_package_debian: python3-mysqldb }
    - geerlingguy.mailhog
    - T2L.php
    - T2L.composer
    - T2L.java
    - { role: T2L.solr, solr_cleanup_downloads: false, solr_cleanup_gpg: false }
  vars_files:
    - ../../default.vm-settings.yml
