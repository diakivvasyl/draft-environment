---
# This is exact copy of main playbook, except oefenweb.swapfile is skipped
# because it's not possible to test it on Travis CI. Also we manually add
# vagrant user as it does not exist in Docker.
- hosts: all
  become: true

  pre_tasks:

    - name: Ensure Ansible temp directory exists
      file:
        path: /tmp/ansible
        state: directory
        mode: 0777

    - name: Ensure base packages are installed
      apt:
        name:
          - libxml2-dev
          - libxslt-dev
          - python3-dev
          - python3-lxml
          - rsync
        state: present
        update_cache: true

    - name: Add vagrant user
      user:
        name: vagrant
        # This password hash has been generated by running the following command
        # with password 'vagrant':
        #
        # mkpasswd --method=sha-512
        password: $6$4kot6S9fS2oGx$gUxPU4xvSSoMku2OHTwPtCDLNCU4OszJMv6616/1DmaLel15k5hNha451ce4tP6hIMd2H.suCv8cb/NNASdPd0
        uid: 1000

    # Some keys in the 'vagrant' dict are being populated by the Vagrant.
    # Molecule uses Docker under the hood. Let's fill the gap.
    - name: Add missing variables
      set_fact:
        vagrant: "{{ vagrant | combine(overrides, recursive=true) }}"
        draft_features:
          - mailhog
          - git_config
          - apache2
          - mysql
          - php
          - composer
          - java
          - solr
      vars:
        overrides:
          hostname: molecule
          ip_address: 10.10.10.10

  roles:
    - ../../provisioning/roles/draft
    - ../../provisioning/roles/git_config
    - ../../provisioning/roles/apache2
    - geerlingguy.mysql
    - geerlingguy.mailhog
    - T2L.php
    - T2L.composer
    - T2L.java
    - T2L.solr
  vars:
    ansible_python_interpreter: /usr/bin/python3
  vars_files:
    - ../../default.vm-settings.yml
